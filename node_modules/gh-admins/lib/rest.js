/**
 * Copyright (c) 2015 "Fronteer LTD"
 * Grasshopper Event Engine
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

var _ = require('lodash');

var GrassHopper = require('gh-core');

var AdminsAPI = require('gh-admins');

/**
 * @REST getGlobalAdmins
 *
 * Get all global administrators
 *
 * @Server      admin
 * @Method      GET
 * @Path        /admins
 * @QueryParam  {number}                [limit]                 The maximum number of results to retrieve. Default: 10
 * @QueryParam  {number}                [offset]                The paging number of the results to retrieve
 * @Return      {GlobalAdminList}                               The users for the requested tenant or app
 */
GrassHopper.globalAdminRouter.on('get', '/api/admins', function(req, res) {
    AdminsAPI.getGlobalAdmins(req.ctx, req.query.limit, req.query.offset, function(err, globalAdmins) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        res.status(200).send(globalAdmins);
    });
});

/**
 * @REST getMe
 *
 * Get the current global administrator
 *
 * @Server      admin
 * @Method      GET
 * @Path        /me
 * @Return      {Me}                                            The current global administrator
 */
GrassHopper.globalAdminRouter.on('get', '/api/me', function(req, res) {
    var me = {
        'anon': true,
        'app': req.ctx.app
    };
    if (req.ctx.user) {
        me = _.extend(me, {'anon': false}, req.ctx.user.toJSON());
    }
    res.status(200).send(me);
});

/**
 * @REST createGlobalAdmin
 *
 * Create a new global administrator
 *
 * @Server      admin
 * @Method      POST
 * @Path        /admins
 * @FormParam   {string}                displayName             The name of the global administrator
 * @FormParam   {string}                password                The password for the global administrator
 * @FormParam   {string}                username                The username for the global administrator
 * @Return      {GlobalAdmin}                                   The created global administrator
 */
GrassHopper.globalAdminRouter.on('post', '/api/admins', function(req, res) {
    AdminsAPI.createGlobalAdmin(req.ctx, req.body.username, req.body.password, req.body.displayName, function(err, globalAdmin) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        res.status(201).send(globalAdmin);
    });
});

/**
 * @REST updateGlobalAdmin
 *
 * Update a global administrator
 *
 * @Server      admin
 * @Method      POST
 * @Path        /admins/{id}
 * @PathParam   {number}                id                      The id of the global administrator to update
 * @FormParam   {string}                displayName             Updated global administrator name
 * @Return      {GlobalAdmin}                                   The updated global administrator
 */
GrassHopper.globalAdminRouter.on('post', '/api/admins/:id', function(req, res) {
    AdminsAPI.updateGlobalAdmin(req.ctx, req.params.id, req.body.displayName, function(err, globalAdmin) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        res.status(200).send(globalAdmin);
    });
});

/**
 * @REST changePassword
 *
 * Change a global administrator's password
 *
 * @Server      admin
 * @Method      POST
 * @Path        /admins/{id}/password
 * @PathParam   {string}            id                      The id of the global administrator for which to change the password
 * @FormParam   {string}            newPassword             The new password for the global administrator
 * @FormParam   {string}            password                The password of the global administrator making the change
 * @Return      {void}
 */
GrassHopper.globalAdminRouter.on('post', '/api/admins/:id/password', function(req, res) {
    AdminsAPI.changePassword(req.ctx, req.params.id, req.body.newPassword, req.body.password, function(err) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        return res.sendStatus(200);
    });
});

/**
 * @REST deleteGlobalAdmin
 *
 * Delete a global administrator
 *
 * @Server      admin
 * @Method      DELETE
 * @Path        /admins/{id}
 * @PathParam   {number}        id      The id of the global administrator to delete
 */
GrassHopper.globalAdminRouter.on('delete', '/api/admins/:id', function(req, res) {
    AdminsAPI.deleteGlobalAdmin(req.ctx, req.params.id, function(err) {
        if (err) {
            return res.status(err.code).send(err.msg);
        }

        res.sendStatus(200);
    });
});
